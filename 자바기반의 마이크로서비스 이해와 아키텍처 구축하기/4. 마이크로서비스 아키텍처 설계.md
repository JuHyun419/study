## 4. 마이크로서비스 아키텍처 설계
  - 마이크로서비스 아키텍처는 마이크로서비스와 아키텍처를 구분해서 생각해야 함
  - 마이크로서비스: 의미 그대로 작은 서비스에 집중하는 것
  - 아키텍처: 작게 만들어진 서비스가 실행될 수 있게 지원하는 기술적인 요소에 집중하는 것
  
<br>

### 마이크로서비스 설계(커피 전문점 서비스)
  - 고객이 '아메리카노' 한 잔을 주문
  - 커피 직원은 고객에게 포인트 적립이나 각종 이벤트 적용 가능 여부를 확인하기 위해 회원 유무를 확인
  - 그리고 '아메리카노' 금액과 주문 번호표를 고객에게 건넴
  - 고객은 커피를 기다리고, 준비되면 직원이 주문 번호를 부르며 커피를 받아간다.
  - 위 사례를 좀 더 확장하면, 각 매장에서 판매되는 현황 데이터를 실시간으로 본사로 전송하여 고객 맞춤형 이벤트 등을 진행할 수 있음
  
#### 서비스 대상은 무엇이며 크기는 적절한가?
  - 마이크로서비스를 설계하기 위한 첫 번째 질문
  - 에릭 에반스의 도메인 주도 설계 에서 서비스의 경계 식별에 대해 잘 설명이 되어있음
  - 필자의 최근 프로젝트에서는 서비스 경계의 기준을 '업무의 흐름', '업무의 중요도', 업무의 형태' 등의 관점으로 접근하여 식별
  - '커피 전문점 서비스' 업무 사례를 살펴보면 다음과 같다.
  - '업무의 흐름' : '커피 주문 처리 -> 커피 제조 -> 주문 처리 상태 알림'
  - '업무의 중요도' : 핵심 업무와 비핵심 업무, 그리고 공통으로 제공해야하는 업무들로 분류하는 것
    - 커피를 주문하고 처리 상태를 알려주는 일은 핵심 업무
    - 이벤트로 설문이나 쿠폰 정보 알림, 무료 인터넷 서비스 등은 비핵심 업무이거나 때에는 공통 업무가 될 수 있음
  - '업무의 형태' : 실시간으로 해결되어야 하는 것인지 아니면 일 단위, 월 단위 등오러 처리되어야 하는 일인지에 대한 분류
    - 주문을 처리하는 것은 실시간으로 해결
    - 일 단위 매출을 정산하는 일은 일 단위로 실행하면 됨
    
### 서비스 설계
  - '커피 주문', '회원 확인', '주문 처리 상태 알림' 의 세 개의 마이크로 서비스 설계
  - 각각의 서비스는 독립된 프로젝트로 구성
  - 커피를 주문한 고객이 회원인지 유무를 확인하는 '회원 확인 서비스'
  - 커피 주문 처리를 하는 '커피 주문 서비스'
  - 커피 주문 내역을 이벤트로 전달받아서 '주문 처리 상태 확인'을 알려주는 서비스
  ```html
                   참조                  알림
  회원 확인(서비스) <--- 커피 주문(서비스) ---> 주문 처리 상태 알림(서비스)
  ```
  - '커피 주문' 서비스는 커피 주문 고객의 회원 여부 확인을 위해 '회원 확인' 서비스를 호출하여 반환되는 결과값을 사용
    - 반환값은 True 혹은 False
  - 커피 주문 내역은 실시간으로 '주문 처리 상태 알림' 서비스로 전달
  - 서로 다른 서비스의 데이터를 참조할 때는 REST API를 이용해서 호출하여 전달
  - 데이터베이스도 관계형 데이터베이스 및 NoSQL 등 필요에 따라 선택
  - 필요에 따라서는 속성들이 각 서비스에 중복해서 정의될 수 있음
  - 중복된 속성 구조를 허용하지 않는다면 ?
    - 매번 다른 마이크로서비스가 가진 데이터를 참조해야 하므로 빈번한 REST API 호출
    - 다른 서비스에 의존성이 높아지기에, 한 서비스에 문제가 생기면 전체 서비스가 영향을 받게됨
    
    ![KakaoTalk_20210221_111408348_01](https://user-images.githubusercontent.com/50076031/108613502-0bcd6c00-7436-11eb-8e4b-f56311230fb0.jpg)
    
    <br>
    
### 메시지 전송 방식 설계
  - 시스템 간 느슨한 결합과 탄력적인 아키텍처 구성을 위해 메시지 큐(Message Queue,MQ)를 이용하여 메시지를 전달하는 이벤트 기반 메시지 전송 방식으로 설계가 이루어져도 무방
  - '커피 전문점 서비스' 사례 ...
    - '커피 주문' 서비스 --> 커피 주문을 처리하고 주문 상태를 메시지 큐로 전달
    - 전달된 메시지는 '주문 처리 상태 확인' 서비스에서 구독(Subscribe)하여 실시간으로 현황을 화면에 보여줌
    - 메시지를 발행하는 서비스를 '생산자(Producer)', 발행된 메시지를 구독하는 서비스를 '소비자(Consumer)' 라고 함

<br>

## 커피 전문점 마이크로서비스 구조 설계
  - '커피 전문점 서비스'는 한 팀에서 여러 개의 독립된 마이크로서비스를 만든다고 가정
  - 프로젝트 소스 크기가 작은 예제, '복수 프로젝트(multi-project)' 환경으로 구성
  - '회원 확인' 프로젝트, '커피 주문' 프로젝트, '주문 처리 상태 확인' 프로젝트 --> 각각의 마이크로 서비스(독립적)
  ```html
                     서비스 연계                  데이터 연계  
  회원 확인 프로젝트 <---------- 커피 주문 프로젝트 ----------> 주문 처리 상태 확인 프로젝트
                     회원명 조회                 주문 내역 전달
  ```
  
  ![KakaoTalk_20210221_111408348](https://user-images.githubusercontent.com/50076031/108613501-0a03a880-7436-11eb-90c3-3fe9082b5edf.jpg)
  
<br>

### 마이크로서비스 아키텍처 설계
  - 마이크로서비스와 마이크로서비스 아키텍처를 구성하기 위해서는 '환경 설정 관리', '서비스 라우팅', '서비스 등록 감지', '서킷 브레이커', '메시징 시스템',' CQRS' 등
  - 위와 같은 몇 가지의 기능과 이를 잘 구성하고 운영하기 위한 '서비스 구성 체계', '테스트 체계', '빌드 및 배포 체계' 등이 필요함
  - MSA의 성공적인 구축 사례로는 넷플릭스(Netflix)가 대표적, 넷플릭스 오픈소스(Netflix OSS)
  
#### 마이크로서비스 아키텍처 구성
  - 마이크로서비스를 지원하는 여러 서비스와 함께 구성되어야 함
  - 서비스의 관리와 모니터링 시스템은 안정적인 운영을 위해 사용되는 에코시스템들의 기능을 더욱 중요하게 만듬
  - 서비스 환경 설정, 서비스 등록 및 감지, 서비스 게이트웨이, 서비스 모니터링 시스템, 큐잉 시스템 등등

  
  
